CREATE DATABASE IF NOT EXISTS TWITTER;
USE TWITTER;

CREATE TABLE IF NOT EXISTS USERS(
	ID	VARCHAR(15) NOT NULL,
	PASSWORD VARCHAR(255) NOT NULL,
    EMAIL	VARCHAR(100) NOT NULL,
    CREATED_AT	DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    BIRTHDAY	DATE  NOT NULL,
    PHONE_NUMBER	VARCHAR(15) NOT NULL,
    PRIMARY KEY(ID),
    UNIQUE(EMAIL)
) ENGINE=InnoDB;

CREATE TABLE IF NOT EXISTS POSTS (
	POST_ID INT NOT NULL AUTO_INCREMENT,
    TEXT TEXT NOT NULL,
    WRITER_ID VARCHAR(15) NOT NULL,
    CREATED_AT DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
	NUM_OF_LIKES INT NOT NULL DEFAULT 0,
	PRIMARY KEY(POST_ID),
    FOREIGN KEY(WRITER_ID) REFERENCES USERS(ID) ON DELETE CASCADE,
    INDEX idx_writer_id (WRITER_ID)
) ENGINE=InnoDB;

CREATE TABLE IF NOT EXISTS HASHTAGS (
    HASHTAG_ID INT NOT NULL AUTO_INCREMENT,
    TAG_NAME VARCHAR(50) NOT NULL UNIQUE,
    PRIMARY KEY(HASHTAG_ID)
) ENGINE=InnoDB;

CREATE TABLE IF NOT EXISTS POST_HASHTAGS (
    POST_ID INT NOT NULL,
    HASHTAG_ID INT NOT NULL,
    PRIMARY KEY(POST_ID, HASHTAG_ID),
    FOREIGN KEY (POST_ID) REFERENCES POSTS(POST_ID) ON DELETE CASCADE,
    FOREIGN KEY (HASHTAG_ID) REFERENCES HASHTAGS(HASHTAG_ID) ON DELETE CASCADE,
    INDEX idx_hashtag_id (HASHTAG_ID)
) ENGINE=InnoDB;

CREATE TABLE IF NOT EXISTS COMMENTS(
	COMMENT_ID INT NOT NULL AUTO_INCREMENT,
    TEXT TEXT NOT NULL,
    WRITER_ID VARCHAR(15) NOT NULL,
    POST_ID INT NOT NULL,
    NUM_OF_LIKES INT NOT NULL DEFAULT 0,
    CREATED_AT DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY(COMMENT_ID),
    FOREIGN KEY(WRITER_ID) REFERENCES USERS(ID) ON DELETE CASCADE,
    FOREIGN KEY (POST_ID) REFERENCES POSTS(POST_ID) ON DELETE CASCADE,
    INDEX idx_comment_writer_id (WRITER_ID),
    INDEX idx_comment_post_id (POST_ID)
) ENGINE=InnoDB;

CREATE TABLE IF NOT EXISTS POST_LIKE (
	POST_ID INT NOT NULL,
    USER_ID VARCHAR(15) NOT NULL,
    CREATED_AT DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY(POST_ID, USER_ID),
    FOREIGN KEY(POST_ID) REFERENCES POSTS(POST_ID) ON DELETE CASCADE,
    FOREIGN KEY(USER_ID) REFERENCES USERS(ID) ON DELETE CASCADE,
    INDEX idx_post_like_user_id (USER_ID)
) ENGINE=InnoDB;

CREATE TABLE IF NOT EXISTS COMMENTS_LIKE (
	COMMENT_ID INT NOT NULL,
    USER_ID VARCHAR(15) NOT NULL,
    CREATED_AT DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY(COMMENT_ID, USER_ID),
    FOREIGN KEY(COMMENT_ID) REFERENCES COMMENTS(COMMENT_ID) ON DELETE CASCADE,
    FOREIGN KEY(USER_ID) REFERENCES USERS(ID) ON DELETE CASCADE,
    INDEX idx_comment_like_user_id (USER_ID)
) ENGINE=InnoDB;

CREATE TABLE IF NOT EXISTS FOLLOW (
    FOLLOWING_ID VARCHAR(15) NOT NULL,
    FOLLOWER_ID VARCHAR(15) NOT NULL,
    CREATE_AT DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (FOLLOWING_ID, FOLLOWER_ID),
    FOREIGN KEY (FOLLOWING_ID) REFERENCES USERS(ID) ON DELETE CASCADE,
    FOREIGN KEY (FOLLOWER_ID) REFERENCES USERS(ID) ON DELETE CASCADE,
    INDEX idx_following_id (FOLLOWING_ID),
    INDEX idx_follower_id (FOLLOWER_ID),
    UNIQUE KEY unique_follow (FOLLOWING_ID, FOLLOWER_ID)
) ENGINE=InnoDB;

CREATE TABLE IF NOT EXISTS SEARCH (
	USER_ID VARCHAR(15) NOT NULL,
    HASHTAG_ID INT NOT NULL,
    SEARCHED_AT DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (USER_ID, HASHTAG_ID),
    FOREIGN KEY (USER_ID) REFERENCES USERS(ID) ON DELETE CASCADE,
    FOREIGN KEY (HASHTAG_ID) REFERENCES HASHTAGS(HASHTAG_ID) ON DELETE CASCADE,
    INDEX idx_search_hashtag_id (HASHTAG_ID)
) ENGINE=InnoDB;

-- Triggers for POST_LIKE
DELIMITER $$

-- Trigger to increase NUM_OF_LIKES when a like is added to a post
CREATE TRIGGER increase_post_likes AFTER INSERT ON POST_LIKE
FOR EACH ROW
BEGIN
    UPDATE POSTS
    SET NUM_OF_LIKES = NUM_OF_LIKES + 1
    WHERE POST_ID = NEW.POST_ID;
END$$

-- Trigger to decrease NUM_OF_LIKES when a like is removed from a post
CREATE TRIGGER decrease_post_likes AFTER DELETE ON POST_LIKE
FOR EACH ROW
BEGIN
    UPDATE POSTS
    SET NUM_OF_LIKES = CASE
        WHEN NUM_OF_LIKES > 0 THEN NUM_OF_LIKES - 1
        ELSE 0
    END
    WHERE POST_ID = OLD.POST_ID;
END$$

-- Triggers for COMMENTS_LIKE
-- Trigger to increase NUM_OF_LIKES when a like is added to a comment
CREATE TRIGGER increase_comment_likes AFTER INSERT ON COMMENTS_LIKE
FOR EACH ROW
BEGIN
    UPDATE COMMENTS
    SET NUM_OF_LIKES = NUM_OF_LIKES + 1
    WHERE COMMENT_ID = NEW.COMMENT_ID;
END$$

-- Trigger to decrease NUM_OF_LIKES when a like is removed from a comment
CREATE TRIGGER decrease_comment_likes AFTER DELETE ON COMMENTS_LIKE
FOR EACH ROW
BEGIN
    UPDATE COMMENTS
    SET NUM_OF_LIKES = CASE
        WHEN NUM_OF_LIKES > 0 THEN NUM_OF_LIKES - 1
        ELSE 0
    END
    WHERE COMMENT_ID = OLD.COMMENT_ID;
END$$

CREATE TRIGGER increase_post_retweets AFTER INSERT ON RETWEETS
FOR EACH ROW
BEGIN
    UPDATE POSTS
    SET NUM_OF_RETWEETS = NUM_OF_RETWEETS + 1
    WHERE POST_ID = NEW.POST_ID;
END$$

CREATE TRIGGER decrease_post_retweets AFTER DELETE ON RETWEETS
FOR EACH ROW
BEGIN
    UPDATE POSTS
    SET NUM_OF_RETWEETS = CASE
        WHEN NUM_OF_RETWEETS > 0 THEN NUM_OF_RETWEETS - 1
        ELSE 0
    END
    WHERE POST_ID = OLD.POST_ID;
END$$

DELIMITER ;


ALTER TABLE POSTS ADD COLUMN IMAGE LONGBLOB;
ALTER TABLE POSTS ADD COLUMN NUM_OF_RETWEETS INT NOT NULL DEFAULT 0;

CREATE TABLE IF NOT EXISTS RETWEETS (
    RETWEET_ID INT NOT NULL AUTO_INCREMENT,
    POST_ID INT NOT NULL,
    USER_ID VARCHAR(15) NOT NULL,
    CREATED_AT DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (RETWEET_ID),
    FOREIGN KEY (POST_ID) REFERENCES POSTS(POST_ID) ON DELETE CASCADE,
    FOREIGN KEY (USER_ID) REFERENCES USERS(ID) ON DELETE CASCADE,
    UNIQUE KEY unique_retweet (POST_ID, USER_ID)
) ENGINE=InnoDB;

ALTER TABLE users
ADD COLUMN profile_image BLOB;
ALTER TABLE POSTS
ADD COLUMN image BLOB;

